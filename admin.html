<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPBS Super Admin - Tamal Dey</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* WHITE THEME DESIGN */
        body { background: #f4f6f8; color: #333; font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
        
        /* LOGIN LAYER */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: #fff; padding: 40px; border-radius: 10px; border: 1px solid #ddd; text-align: center; width: 90%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-input { width: 100%; padding: 15px; margin: 20px 0; background: #f9f9f9; border: 2px solid #ddd; color: #333; font-size: 24px; text-align: center; border-radius: 8px; letter-spacing: 5px; font-weight: bold; }
        .btn-unlock { background: #d32f2f; color: white; width: 100%; padding: 15px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        
        /* MAIN LAYOUT */
        .container { max-width: 900px; margin: 0 auto; display: none; padding-bottom: 100px; }
        
        /* HEADER */
        .header-box { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-left: 5px solid #d32f2f; }
        .title { font-size: 24px; font-weight: 900; color: #d32f2f; text-transform: uppercase; }
        .admin-name { font-size: 14px; color: #555; font-weight: 600; background: #eee; padding: 5px 12px; border-radius: 20px; }

        /* CARDS */
        .card { background: #fff; border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 1px solid #e0e0e0; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .card-header { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 20px; display: flex; align-items: center; text-transform: uppercase; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .card-icon { margin-right: 10px; color: #d32f2f; }

        /* LIVE STATS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; }
        .stat-box { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef; }
        .stat-num { font-size: 32px; font-weight: 900; color: #d32f2f; }
        .stat-label { font-size: 13px; color: #777; font-weight: bold; margin-top: 5px; text-transform: uppercase; }

        /* INPUTS & FORMS */
        input[type="text"], select, textarea { width: 100%; padding: 12px; background: #fff; border: 2px solid #eee; color: #333; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; font-size: 15px; font-family: inherit; transition: 0.3s; }
        input:focus { border-color: #d32f2f; outline: none; }
        
        /* API FIELD DESIGN */
        .api-field { background: #fff8e1; border-color: #ffe0b2 !important; font-family: monospace; color: #d84315 !important; font-weight: bold; }
        .api-label { font-size: 12px; color: #f57c00; font-weight: bold; display: block; margin-bottom: 5px; }

        /* CHANNEL LIST */
        .channel-list { max-height: 250px; overflow-y: auto; background: #f9f9f9; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .channel-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 14px; background: #fff; }
        .channel-item:last-child { border-bottom: none; }
        
        /* BUTTONS */
        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background: #2196f3; color: white; height: 46px; }
        .btn-add:hover { background: #1976d2; }
        .btn-del { background: #ffebee; color: #c62828; padding: 6px 12px; border-radius: 4px; }
        .btn-del:hover { background: #ffcdd2; }
        
        .btn-magic { background: linear-gradient(135deg, #ff6f00, #ff8f00); color: white; width: 100%; padding: 15px; font-size: 16px; margin-top: 10px; box-shadow: 0 5px 15px rgba(255, 111, 0, 0.3); }
        .btn-copy { background: #333; color: white; width: 100%; margin-top: 8px; border: 1px solid #555; }
        
        .btn-save { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: #2e7d32; color: white; padding: 18px; font-size: 18px; font-weight: bold; border-radius: 50px; box-shadow: 0 10px 30px rgba(46, 125, 50, 0.4); z-index: 100; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; }
        .btn-save:hover { transform: translateX(-50%) scale(1.05); }

        /* LOADING SPINNER */
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:#d32f2f; margin:0 0 10px 0;"><i class="fa-solid fa-lock"></i> SECURE ACCESS</h2>
            <p style="color:#666; font-size:14px; margin-bottom:20px;">Tamal Dey's Control Room</p>
            <input type="password" id="pass-input" class="login-input" placeholder="ENTER PIN" onkeydown="if(event.key === 'Enter') checkPass()">
            <button class="btn-unlock" onclick="checkPass()">UNLOCK PANEL</button>
            <p id="err-msg" style="color:#d32f2f; margin-top:15px; display:none; font-weight:bold;">‚õî WRONG PIN</p>
        </div>
    </div>

    <div class="container" id="main-panel">
        
        <div class="header-box">
            <div class="title"><i class="fa-solid fa-tower-broadcast"></i> LPBS AI CONTROL</div>
            <div class="admin-name"><i class="fa-solid fa-user-tie"></i> Admin: Tamal Dey</div>
        </div>

        <div style="margin-bottom: 25px; text-align: center;">
            <a href="promo.html" style="background: linear-gradient(45deg, #6200ea, #b388ff); color: white; padding: 15px 30px; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 16px; box-shadow: 0 5px 15px rgba(98, 0, 234, 0.3); display: inline-flex; align-items: center; gap: 10px; transition: transform 0.2s;">
                <i class="fa-solid fa-robot" style="font-size: 20px;"></i> 
                LAUNCH AI VIDEO PROMO BOT
            </a>
        </div>

        <div class="card" style="border: 1px solid #00bcd4;">
            <div class="card-header" style="color: #008ba3;">
                <i class="fa-solid fa-user-doctor card-icon"></i> AI System Doctor
            </div>
            <p style="font-size: 13px; color: #666;">
                ‡¶∞‡ßã‡¶¨‡¶ü‡¶ï‡ßá ‡¶¨‡¶≤‡ßÅ‡¶® ‡¶™‡ßÅ‡¶∞‡ßã ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡¶ø‡¶§‡ßá‡•§ ‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶¨‡¶æ ‡¶ï‡ßÄ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü, AI ‡¶¨‡¶≤‡ßá ‡¶¶‡ßá‡¶¨‡ßá‡•§
            </p>
            <button class="btn" style="background: #00bcd4; color: white; width: 100%; font-weight: bold;" onclick="checkSystemHealth()">
                <i class="fa-solid fa-stethoscope"></i> RUN DIAGNOSIS & GET ADVICE
            </button>
            
            <div id="health-result" style="display:none; margin-top: 15px; background: #e0f7fa; padding: 15px; border-radius: 8px;">
                <strong>üìã System Status:</strong>
                <pre id="sys-report" style="font-size: 11px; margin-bottom: 10px;"></pre>
                <hr>
                <strong>ü§ñ AI Engineer Says:</strong>
                <p id="ai-advice" style="color: #006064; font-weight: bold;"></p>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="fa-solid fa-chart-line card-icon"></i> Real-Time Traffic</div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-num" id="count-today">...</div>
                    <div class="stat-label">Visitors Today</div>
                </div>
                <div class="stat-box" style="border-color:#d32f2f;">
                    <div class="stat-num" id="count-total">...</div>
                    <div class="stat-label">Total Views (Lifetime)</div>
                </div>
            </div>
        </div>

        <div class="card" style="border: 1px solid #ff9800;">
            <div class="card-header" style="color:#ef6c00;"><i class="fa-solid fa-fire card-icon" style="color:#ef6c00;"></i> Viral Post Generator</div>
            
            <label style="font-size:13px; color:#666; font-weight:bold;">Select News to Viral:</label>
            <select id="promo-news-list" onchange="resetPreview()"><option>Loading...</option></select>
            
            <div style="display:flex; gap:10px;">
                <select id="promo-lang">
                    <option value="bn">Bangla (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
                    <option value="hi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                    <option value="en">English</option>
                </select>
            </div>

            <button class="btn btn-magic" id="gen-btn" onclick="generatePromo()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> CREATE VIRAL IMAGE
            </button>
            
            <div id="preview-box" style="display:none; margin-top:20px; background:#fafafa; padding:15px; border-radius:10px; border:1px solid #eee;">
                <img id="prev-img" style="width:100%; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;" src="">
                
                <label style="color:#333; font-size:13px; font-weight:bold;">1. Caption (Copy & Paste on FB):</label>
                <textarea id="prev-caption" rows="4"></textarea>
                <button class="btn btn-copy" onclick="copyCaption()"><i class="fa-regular fa-copy"></i> Copy Caption</button>

                <label style="color:#2e7d32; font-size:13px; font-weight:bold; margin-top:15px; display:block;">2. First Comment Link:</label>
                <input type="text" id="prev-link" style="border-color:#2e7d32; color:#2e7d32; font-weight:bold;">
                <button class="btn btn-copy" onclick="copyLink()" style="background:#2e7d32; border:none;"><i class="fa-solid fa-link"></i> Copy Link</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="fa-solid fa-location-dot card-icon"></i> Location Override</div>
            <input type="text" id="loc-input" placeholder="e.g. Kolkata, West Bengal (Leave empty for auto)">
        </div>

        <div id="category-container"></div>

        <button class="btn-save" onclick="saveConfig()">
            <i class="fa-solid fa-floppy-disk"></i> SAVE ALL CHANGES
        </button>
    </div>

    <script>
        const categories = [
            { id: 'live', name: 'üî¥ Live Channels' },
            { id: 'breaking', name: 'üö® Breaking News' },
            { id: 'sports', name: 'üèè Sports' },
            { id: 'tech', name: 'üéÆ Tech' },
            { id: 'entertainment', name: 'üé≠ Entertainment' },
            { id: 'movies', name: 'üçø Movies' },
            { id: 'viral', name: '‚ö° Viral (FB/YT)' }
        ];

        let config = { channels: {}, apis: {} }; // Added 'apis' object
        let newsData = [];

        // --- AUTH ---
        // ‡¶™‡¶ø‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡ßã‡¶°
        if(sessionStorage.getItem('lpbs_admin') === 'ok') {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-panel').style.display = 'block';
        }

        function checkPass() {
            // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶™‡¶ø‡¶®: 33982625
            if(document.getElementById('pass-input').value === '33982625') { 
                sessionStorage.setItem('lpbs_admin', 'ok');
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-panel').style.display = 'block';
            } else {
                document.getElementById('err-msg').style.display = 'block';
            }
        }

        // --- INIT ---
        function initCategories() {
            const container = document.getElementById('category-container');
            container.innerHTML = '';
            categories.forEach(cat => {
                let placeholder = "Paste YouTube Video/Channel Link...";
                if(cat.id === 'viral') placeholder = "Paste Facebook or YouTube Link...";
                
                container.innerHTML += `
                <div class="card">
                    <div class="card-header">${cat.name}</div>
                    
                    <div style="margin-bottom:15px;">
                        <span class="api-label"><i class="fa-solid fa-robot"></i> Robot Search Query (API Keyword):</span>
                        <input type="text" id="api-${cat.id}" class="api-field" placeholder="e.g. Latest Bollywood News, IPL Highlights">
                    </div>

                    <div id="list-${cat.id}" class="channel-list"></div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="new-${cat.id}" placeholder="${placeholder}" style="margin-bottom:0;">
                        <button class="btn btn-add" onclick="addLink('${cat.id}')"><i class="fa-solid fa-plus"></i> ADD</button>
                    </div>
                </div>`;
            });
        }

        // --- LOAD DATA ---
        async function loadData() {
            try {
                // Load Config
                const res = await fetch('config.json?v=' + Date.now());
                if(res.ok) config = await res.json();
                if(!config.channels) config.channels = {};
                if(!config.apis) config.apis = {}; 
                
                document.getElementById('loc-input').value = config.location_override || "";
                
                // Populate Fields
                categories.forEach(cat => {
                    renderList(cat.id);
                    document.getElementById(`api-${cat.id}`).value = config.apis[cat.id] || "";
                });

            } catch(e) { console.error(e); }

            // üëáüëáüëá Render URL INTEGRATED HERE for Real-Time Stats (FIXED) üëáüëáüëá
            // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ï‡ßã‡¶°‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶æ ‡¶≠‡ßÅ‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶õ‡¶ø‡¶≤, ‡¶∏‡ßá‡¶ü‡¶æ ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∏‡¶≤‡¶ü‡¶æ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§
            try {
                const renderURL = "https://lpbs-news.onrender.com"; 
                const res = await fetch(renderURL + '/get_stats');
                const data = await res.json();
                document.getElementById('count-today').innerText = data.today;
                document.getElementById('count-total').innerText = data.total;
            } catch(e) {
                console.log("Stats loading error:", e);
                document.getElementById('count-today').innerText = "Offline";
                document.getElementById('count-total').innerText = "Offline";
            }
            // üëÜüëÜüëÜ End of Stats Update üëÜüëÜüëÜ

            // Load News for Promo
            try {
                const res = await fetch('news_db.json?v=' + Date.now());
                const data = await res.json();
                newsData = data.news || [];
                const select = document.getElementById('promo-news-list');
                select.innerHTML = '<option value="">-- Select News --</option>';
                newsData.slice(0, 20).forEach((n, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.innerText = `[${n.time}] ${n.title.substring(0, 60)}...`;
                    select.appendChild(opt);
                });
            } catch(e) {}
        }

        function renderList(catId) {
            const listDiv = document.getElementById('list-' + catId);
            listDiv.innerHTML = "";
            const links = config.channels[catId] || [];
            
            if(links.length === 0) {
                listDiv.innerHTML = '<div style="padding:15px; color:#999; text-align:center; font-style:italic;">No manual links added. Robot will use API keywords.</div>';
                return;
            }

            links.forEach((url, idx) => {
                let icon = '<i class="fa-brands fa-youtube" style="color:red; margin-right:8px;"></i>';
                if(url.includes('facebook') || url.includes('fb.watch')) {
                    icon = '<i class="fa-brands fa-facebook" style="color:#1877F2; margin-right:8px;"></i>';
                }

                listDiv.innerHTML += `
                <div class="channel-item">
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:80%; color:#333;">
                        ${icon} ${url}
                    </span>
                    <button class="btn btn-del" onclick="removeLink('${catId}', ${idx})"><i class="fa-solid fa-trash"></i></button>
                </div>`;
            });
        }

        // --- ACTIONS ---
        window.addLink = function(catId) {
            const inp = document.getElementById('new-' + catId);
            const val = inp.value.trim();
            if(val) {
                if(!config.channels[catId]) config.channels[catId] = [];
                config.channels[catId].push(val);
                inp.value = "";
                renderList(catId);
            }
        }

        window.removeLink = function(catId, idx) {
            config.channels[catId].splice(idx, 1);
            renderList(catId);
        }

        window.saveConfig = async function() {
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div> SAVING...';
            btn.disabled = true;
            
            config.location_override = document.getElementById('loc-input').value;
            
            // Save API Keywords
            categories.forEach(cat => {
                config.apis[cat.id] = document.getElementById(`api-${cat.id}`).value;
            });
            
            try {
                await fetch('/save_config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> SAVED SUCCESSFULLY!';
                    btn.style.background = '#4caf50';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#2e7d32';
                        btn.disabled = false;
                    }, 2000);
                }, 1000);
            } catch(e) {
                alert("Save Failed! Check connection.");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- VIRAL PROMO ---
        function resetPreview() { document.getElementById('preview-box').style.display = 'none'; }

        window.generatePromo = async function() {
            const idx = document.getElementById('promo-news-list').value;
            const lang = document.getElementById('promo-lang').value;
            
            if(idx === "") { alert("Please select a news first!"); return; }
            
            const btn = document.getElementById('gen-btn');
            btn.innerHTML = '<div class="loader"></div> Processing...';
            btn.disabled = true;

            const news = newsData[idx];

            try {
                const res = await fetch('/create_promo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title: news.title, thumb: news.thumb, lang: lang })
                });
                
                const result = await res.json();
                
                if(result.status === 'success') {
                    const imgUrl = result.image_url; 
                    const link = `https://news.lpbs.in/article.html?id=${news.id}`;
                    const hashtags = result.hashtags;
                    
                    let caption = "";
                    if(lang === 'bn') {
                        caption = `üî• ‡¶¨‡ßç‡¶∞‡ßá‡¶ï‡¶ø‡¶Ç: ${news.title}\n\n‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® üëáüëá\n(Link in First Comment)\n\n${hashtags}`;
                    } else if(lang === 'hi') {
                        caption = `‚ö° ‡§¨‡•ç‡§∞‡•á‡§ï‡§ø‡§Ç‡§ó: ${news.title}\n\n‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è ‡§™‡§π‡§≤‡•á ‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç üëáüëá\n(Link in First Comment)\n\n${hashtags}`;
                    } else {
                        caption = `üö® BREAKING: ${news.title}\n\nWatch Full Video Here (Check First Comment) üëáüëá\n\n${hashtags}`;
                    }

                    document.getElementById('prev-img').src = imgUrl;
                    document.getElementById('prev-caption').value = caption;
                    document.getElementById('prev-link').value = link;
                    
                    document.getElementById('preview-box').style.display = 'block';
                }
            } catch(e) { alert("Server Error! Robot might be sleeping."); }

            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> CREATE VIRAL IMAGE';
            btn.disabled = false;
        }

        window.copyCaption = function() {
            const el = document.getElementById('prev-caption');
            el.select(); document.execCommand('copy');
            alert("Caption Copied!");
        }
        window.copyLink = function() {
            const el = document.getElementById('prev-link');
            el.select(); document.execCommand('copy');
            alert("Link Copied!");
        }

        // START
        initCategories();
        loadData();
    </script>
</body>
</html>
