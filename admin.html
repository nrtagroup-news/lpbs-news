<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPBS Super Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0f0f0f; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; }
        
        /* SECURITY LAYER */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: #1a1a1a; padding: 30px; border-radius: 15px; border: 1px solid #d32f2f; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 0 40px rgba(211, 47, 47, 0.4); }
        .login-input { width: 100%; padding: 15px; margin: 15px 0; background: #222; border: 1px solid #444; color: white; font-size: 20px; text-align: center; border-radius: 8px; letter-spacing: 5px; font-weight: bold; }
        .btn-unlock { background: #d32f2f; color: white; width: 100%; padding: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        
        /* MAIN LAYOUT */
        .container { max-width: 800px; margin: 0 auto; display: none; padding-bottom: 80px; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
        
        /* CARDS */
        .card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .card-header { font-size: 16px; font-weight: bold; color: #aaa; margin-bottom: 15px; display: flex; align-items: center; text-transform: uppercase; letter-spacing: 1px; }
        .card-icon { margin-right: 10px; color: #d32f2f; }

        /* LIVE STATS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
        .stat-box { background: #252525; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        .stat-num { font-size: 24px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 12px; color: #888; margin-top: 5px; }
        .pulse { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); } }

        /* VIRAL PROMO MAKER */
        .promo-box { border: 1px dashed #ff6f00; background: #1a1005; }
        .preview-area { display: none; margin-top: 15px; background: #000; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .preview-img { width: 100%; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        
        /* FORMS */
        select, input[type="text"], textarea { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }
        
        /* CHANNEL LIST */
        .channel-list { max-height: 250px; overflow-y: auto; background: #151515; border-radius: 6px; margin-bottom: 10px; }
        .channel-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #2a2a2a; font-size: 13px; }
        .channel-item:last-child { border-bottom: none; }
        
        /* BUTTONS */
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; }
        .btn-add { background: #1565c0; color: white; width: 100%; }
        .btn-del { background: #c62828; color: white; padding: 5px 10px; border-radius: 4px; }
        .btn-magic { background: linear-gradient(135deg, #d32f2f, #ff6f00); color: white; width: 100%; font-size: 16px; padding: 12px; margin-top: 5px; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3); }
        .btn-copy { background: #333; color: white; width: 100%; margin-top: 5px; border: 1px solid #555; }
        .btn-copy:active { background: #00e676; border-color: #00e676; }
        
        .btn-save { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; background: #2e7d32; color: white; padding: 15px; font-size: 18px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* LOADING SPINNER */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #d32f2f; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="justify-content:center; border:none; color:#d32f2f; margin:0;"><i class="fa-solid fa-user-secret"></i> ADMIN</h2>
            <p style="color:#666; font-size:12px; margin-top:5px;">System Security Active</p>
            <input type="password" id="pass-input" class="login-input" placeholder="CODE">
            <button class="btn-unlock" onclick="checkPass()">ACCESS PANEL</button>
            <p id="err-msg" style="color:#ff3333; margin-top:15px; display:none; font-weight:bold;">‚õî ACCESS DENIED</p>
        </div>
    </div>

    <div class="container" id="main-panel">
        <h2 style="color:white;">
            <span><i class="fa-solid fa-robot" style="color:#00e676;"></i> LPBS AI CONTROL</span>
            <span style="font-size:12px; background:#333; padding:5px 10px; border-radius:20px;">v2.5 (FB Logic)</span>
        </h2>

        <div class="card" style="border-top: 4px solid #00e676;">
            <div class="card-header"><i class="fa-solid fa-chart-line card-icon"></i> Live Traffic</div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-num" style="color:#00e676;" id="count-today">0</div>
                    <div class="stat-label">TODAY</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" style="color:#ffea00;" id="count-total">0</div>
                    <div class="stat-label">LIFETIME</div>
                </div>
            </div>
            <div style="text-align:center; margin-top:10px; font-size:12px; color:#555;">
                <i class="fa-solid fa-circle pulse" style="color:#00e676; font-size:8px;"></i> System is Online
            </div>
        </div>

        <div class="card promo-box">
            <div class="card-header" style="color:#ff9800;"><i class="fa-solid fa-fire card-icon"></i> Viral Post Maker</div>
            
            <label style="font-size:12px; color:#aaa;">Select Trending News:</label>
            <select id="promo-news-list" onchange="resetPreview()"><option>Loading News...</option></select>
            
            <div style="display:flex; gap:10px;">
                <select id="promo-lang">
                    <option value="bn">Bangla (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
                    <option value="hi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                    <option value="en">English</option>
                </select>
            </div>

            <button class="btn btn-magic" id="gen-btn" onclick="generatePromo()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> GENERATE VIRAL IMAGE
            </button>
            
            <div id="preview-box" class="preview-area">
                <img id="prev-img" class="preview-img" src="">
                
                <label style="color:#aaa; font-size:12px;">1. Post Caption (Copy This):</label>
                <textarea id="prev-caption" rows="5"></textarea>
                <button class="btn btn-copy" onclick="copyCaption()">
                    <i class="fa-solid fa-copy"></i> Copy Caption
                </button>

                <label style="color:#00e676; font-size:12px; margin-top:10px; display:block;">2. Link for First Comment:</label>
                <input type="text" id="prev-link" style="border-color:#00e676; color:#00e676; font-weight:bold;">
                <button class="btn btn-copy" onclick="copyLink()">
                    <i class="fa-solid fa-link"></i> Copy Link
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="fa-solid fa-map-location-dot card-icon"></i> Location Override</div>
            <input type="text" id="loc-input" placeholder="e.g. Kolkata, West Bengal">
        </div>

        <div id="category-container"></div>

        <button class="btn-save" onclick="saveConfig()">
            <i class="fa-solid fa-floppy-disk"></i> SAVE CHANGES
        </button>
        <div id="msg" style="text-align:center; color:#00e676; margin-top:10px; display:none; position:fixed; bottom:80px; left:0; width:100%; background:rgba(0,0,0,0.8); padding:5px;"></div>
    </div>

    <script>
        // --- UPDATED CATEGORIES (YOUR REQUEST) ---
        const categories = [
            { id: 'live', name: 'üî¥ Live Channels' },
            { id: 'breaking', name: 'üö® Breaking News' },
            { id: 'sports', name: 'üèè Sports' },
            { id: 'entertainment', name: 'üé≠ Entertainment' },  // Renamed
            { id: 'movies', name: 'üçø Movies' },            // New Category
            { id: 'viral', name: '‚ö° Viral (FB/YouTube)' }   // Facebook Supported
        ];

        let config = { channels: {} };
        let newsData = [];

        // --- AUTHENTICATION ---
        if(sessionStorage.getItem('lpbs_admin') === 'ok') {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-panel').style.display = 'block';
        }

        function checkPass() {
            const pass = document.getElementById('pass-input').value;
            if(pass === '33982625') { 
                sessionStorage.setItem('lpbs_admin', 'ok');
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-panel').style.display = 'block';
            } else {
                document.getElementById('err-msg').style.display = 'block';
                document.getElementById('pass-input').value = "";
            }
        }

        // --- INITIALIZATION ---
        function initCategories() {
            const container = document.getElementById('category-container');
            container.innerHTML = '';
            categories.forEach(cat => {
                let placeholder = "Paste YouTube Link...";
                if(cat.id === 'viral') placeholder = "Paste Facebook or YouTube Link...";
                
                container.innerHTML += `
                <div class="card">
                    <div class="card-header">${cat.name}</div>
                    <div id="list-${cat.id}" class="channel-list"></div>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <input type="text" id="new-${cat.id}" placeholder="${placeholder}" style="margin-bottom:0;">
                        <button class="btn btn-add" style="width:auto; padding:0 20px;" onclick="addLink('${cat.id}')">ADD</button>
                    </div>
                </div>`;
            });
        }

        // --- CORE FUNCTIONS ---
        async function loadData() {
            try {
                const res = await fetch('config.json?v=' + Date.now());
                if(res.ok) config = await res.json();
                if(!config.channels) config.channels = {};
                
                document.getElementById('loc-input').value = config.location_override || "";
                categories.forEach(cat => renderList(cat.id));
            } catch(e) { console.error("Config Load Error", e); }

            try {
                const res = await fetch('/get_stats');
                const data = await res.json();
                document.getElementById('count-today').innerText = data.today;
                document.getElementById('count-total').innerText = data.total;
            } catch(e) {}

            try {
                const res = await fetch('news_db.json?v=' + Date.now());
                const data = await res.json();
                newsData = data.news || [];
                const select = document.getElementById('promo-news-list');
                select.innerHTML = '<option value="">-- Select a News to Viral --</option>';
                newsData.slice(0, 20).forEach((n, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.innerText = `[${n.time}] ${n.title.substring(0, 60)}...`;
                    select.appendChild(opt);
                });
            } catch(e) {}
        }

        function renderList(catId) {
            const listDiv = document.getElementById('list-' + catId);
            listDiv.innerHTML = "";
            const links = config.channels[catId] || [];
            
            if(links.length === 0) {
                listDiv.innerHTML = '<div style="padding:10px; color:#555; text-align:center;">No links added</div>';
                return;
            }

            links.forEach((url, idx) => {
                let icon = '<i class="fa-brands fa-youtube" style="color:red; margin-right:5px;"></i>';
                if(url.includes('facebook') || url.includes('fb.watch')) {
                    icon = '<i class="fa-brands fa-facebook" style="color:#1877F2; margin-right:5px;"></i>';
                }

                listDiv.innerHTML += `
                <div class="channel-item">
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:80%;">
                        ${icon} ${url}
                    </span>
                    <button class="btn btn-del" onclick="removeLink('${catId}', ${idx})"><i class="fa-solid fa-trash"></i></button>
                </div>`;
            });
        }

        // --- ACTIONS ---
        window.addLink = function(catId) {
            const inp = document.getElementById('new-' + catId);
            const val = inp.value.trim();
            if(val) {
                if(!config.channels[catId]) config.channels[catId] = [];
                config.channels[catId].push(val);
                inp.value = "";
                renderList(catId);
            }
        }

        window.removeLink = function(catId, idx) {
            config.channels[catId].splice(idx, 1);
            renderList(catId);
        }

        window.saveConfig = async function() {
            const btn = document.querySelector('.btn-save');
            btn.innerHTML = '<div class="loader"></div> SAVING...';
            
            config.location_override = document.getElementById('loc-input').value;
            
            await fetch('/save_config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });

            setTimeout(() => {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> SAVED!';
                btn.style.background = '#00e676';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> SAVE CHANGES';
                    btn.style.background = '#2e7d32';
                }, 2000);
            }, 1000);
        }

        // --- VIRAL PROMO LOGIC (FIRST COMMENT SYSTEM) ---
        function resetPreview() {
            document.getElementById('preview-box').style.display = 'none';
        }

        window.generatePromo = async function() {
            const idx = document.getElementById('promo-news-list').value;
            const lang = document.getElementById('promo-lang').value;
            
            if(idx === "") { alert("Please select a news first!"); return; }
            
            const btn = document.getElementById('gen-btn');
            btn.innerHTML = '<div class="loader"></div> Processing...';
            btn.disabled = true;

            const news = newsData[idx];

            try {
                const res = await fetch('/create_promo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: news.title,
                        thumb: news.thumb,
                        lang: lang
                    })
                });
                
                const result = await res.json();
                
                if(result.status === 'success') {
                    const imgUrl = result.image_url; 
                    const link = `https://news.lpbs.in/article.html?id=${news.id}`;
                    const hashtags = result.hashtags;
                    
                    // SMART CAPTION LOGIC (Text points to First Comment)
                    let caption = "";
                    if(lang === 'bn') {
                        caption = `üî• ‡¶¨‡ßç‡¶∞‡ßá‡¶ï‡¶ø‡¶Ç: ${news.title}\n\n‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® üëáüëá\n(Link in First Comment)\n\n${hashtags}`;
                    } else if(lang === 'hi') {
                        caption = `‚ö° ‡§¨‡•ç‡§∞‡•á‡§ï‡§ø‡§Ç‡§ó: ${news.title}\n\n‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è ‡§™‡§π‡§≤‡•á ‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç üëáüëá\n(Link in First Comment)\n\n${hashtags}`;
                    } else {
                        caption = `üö® BREAKING: ${news.title}\n\nWatch Full Video Here (Check First Comment) üëáüëá\n\n${hashtags}`;
                    }

                    document.getElementById('prev-img').src = imgUrl;
                    document.getElementById('prev-caption').value = caption;
                    document.getElementById('prev-link').value = link;
                    
                    document.getElementById('preview-box').style.display = 'block';
                }
            } catch(e) {
                alert("Server Error! Robot might be sleeping.");
            }

            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> GENERATE VIRAL IMAGE';
            btn.disabled = false;
        }

        window.copyCaption = function() {
            const el = document.getElementById('prev-caption');
            el.select();
            document.execCommand('copy');
            alert("Caption Copied! Now Paste on Facebook.");
        }

        window.copyLink = function() {
            const el = document.getElementById('prev-link');
            el.select();
            document.execCommand('copy');
            alert("Link Copied! Paste this in the First Comment.");
        }

        // Start
        initCategories();
        loadData();
    </script>
</body>
</html>
